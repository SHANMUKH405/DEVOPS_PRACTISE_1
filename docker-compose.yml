# ============================================================================
# DOCKER COMPOSE CONFIGURATION
# ============================================================================
# This file defines multiple containers that work together
# 
# Docker Compose lets us:
# - Define multiple services (containers)
# - Set up networking between them
# - Configure volumes, environment variables, etc.
# - Start/stop everything with one command
#
# This is "Infrastructure as Code" - we define our entire setup in a file
# ============================================================================
# Note: The 'version' field is no longer needed in newer Docker Compose versions
# It's been removed to avoid the warning

# ----------------------------------------------------------------------------
# SERVICES (Containers)
# ----------------------------------------------------------------------------
# Each service is a container that will be created

services:
  # --------------------------------------------------------------------------
  # WEB SERVICE - Our Flask Application
  # --------------------------------------------------------------------------
  web:
    # Build the image from current directory
    # Uses the Dockerfile in the current directory
    build:
      context: .  # Current directory
      dockerfile: Dockerfile  # Use this Dockerfile
    
    # Give the container a friendly name
    container_name: devops-learning-app
    
    # Port mapping: host_port:container_port
    # Access the app at localhost:5001 (changed from 5000 because macOS uses port 5000)
    # Format: "host_port:container_port" - maps host port to container port
    ports:
      - "5001:5000"
    
    # Environment variables
    # These can be changed without modifying code
    environment:
      - APP_NAME=My First DevOps App!
      - APP_VERSION=1.0.0
      - ENVIRONMENT=production
      - PORT=5000
      # Database connection settings
      - DATABASE_URL=postgresql://devops_user:devops_pass@db:5432/devops_db
    
    # Volume mounting (optional, for development)
    # This lets you edit code and see changes without rebuilding
    # :ro means "read-only" (container can't modify the file)
    volumes:
      - ./app.py:/app/app.py:ro
    
    # Restart policy
    # unless-stopped = Always restart unless manually stopped
    restart: unless-stopped
    
    # Health check configuration
    # Docker Compose will check this to know if service is healthy
    # If health check fails, Docker Compose can restart the service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s      # Check every 30 seconds
      timeout: 10s       # Timeout after 10 seconds
      retries: 3         # Retry 3 times before marking unhealthy
      start_period: 40s  # Wait 40 seconds before first check (gives app time to start)
    
    # Network configuration
    # All services on the same network can talk to each other
    networks:
      - devops-network
    
    # Dependencies
    # Wait for database to be healthy before starting web app
    depends_on:
      db:
        condition: service_healthy

  # --------------------------------------------------------------------------
  # NGINX SERVICE - Reverse Proxy / Web Server
  # --------------------------------------------------------------------------
  # Nginx is a web server that can:
  # - Act as reverse proxy (forward requests to our app)
  # - Handle load balancing
  # - Serve static files
  # - Handle SSL/TLS
  nginx:
    # Use pre-built Nginx image (don't build from Dockerfile)
    image: nginx:alpine  # Alpine = smaller Linux distribution
    
    container_name: devops-nginx
    
    # Map port 80 (standard HTTP port) to container port 80
    ports:
      - "80:80"
    
    # Mount Nginx configuration file
    # This tells Nginx how to route traffic
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    
    # Dependencies
    # Start "web" service first, then start nginx
    depends_on:
      - web
    
    # Network configuration
    networks:
      - devops-network

  # --------------------------------------------------------------------------
  # DATABASE SERVICE - PostgreSQL
  # --------------------------------------------------------------------------
  # PostgreSQL is a powerful open-source relational database
  # 
  # Why add a database?
  # - Store data persistently (survives container restarts)
  # - Learn about multi-service applications
  # - Understand database connections
  # - Practice with real-world scenarios
  db:
    # Use official PostgreSQL image
    image: postgres:15-alpine  # Alpine = smaller image
    
    container_name: devops-postgres
    
    # Environment variables for database setup
    environment:
      - POSTGRES_USER=devops_user          # Database username
      - POSTGRES_PASSWORD=devops_pass      # Database password
      - POSTGRES_DB=devops_db              # Database name
      - PGDATA=/var/lib/postgresql/data/pgdata  # Data directory
    
    # Port mapping (optional - for external access)
    # 5432 is the default PostgreSQL port
    ports:
      - "5432:5432"
    
    # VOLUMES - Persistent Storage!
    # This is KEY: Without volumes, data is lost when container stops
    # With volumes, data persists on your host machine
    volumes:
      # Named volume for database data
      # This persists data even if container is removed
      - postgres_data:/var/lib/postgresql/data
    
    # Restart policy
    restart: unless-stopped
    
    # Health check - ensure database is ready
    # pg_isready checks if PostgreSQL is accepting connections
    # This ensures the database is fully initialized before other services start
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devops_user -d devops_db"]
      interval: 10s      # Check every 10 seconds
      timeout: 5s        # Timeout after 5 seconds
      retries: 5         # Retry 5 times before marking unhealthy
      start_period: 10s  # Wait 10 seconds before first check
    
    # Network configuration
    networks:
      - devops-network

# ----------------------------------------------------------------------------
# NETWORKS
# ----------------------------------------------------------------------------
# Networks allow containers to communicate with each other
# Containers on the same network can reach each other by service name

# ----------------------------------------------------------------------------
# VOLUMES
# ----------------------------------------------------------------------------
# Volumes provide persistent storage
# Data in volumes survives container removal and restarts
#
# Why volumes?
# - Database data needs to persist
# - Without volumes, data is lost when container stops
# - Volumes store data on your host machine

volumes:
  postgres_data:
    # Named volume - Docker manages this
    # Data is stored in Docker's volume directory
    # To see volumes: docker volume ls
    # To inspect: docker volume inspect devops_prac1_postgres_data

# ----------------------------------------------------------------------------
# NETWORKS
# ----------------------------------------------------------------------------
# Networks allow containers to communicate with each other
# Containers on the same network can reach each other by service name

networks:
  devops-network:
    driver: bridge  # Bridge network (default, containers can communicate)

# ============================================================================
# HOW TO USE THIS FILE
# ============================================================================
# 
# Start all services:
#   docker-compose up -d
#
# Stop all services:
#   docker-compose down
#
# View logs:
#   docker-compose logs -f
#
# Rebuild and restart:
#   docker-compose up -d --build
#
# ============================================================================
