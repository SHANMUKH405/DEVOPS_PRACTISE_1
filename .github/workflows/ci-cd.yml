# ============================================================================
# GITHUB ACTIONS CI/CD PIPELINE
# ============================================================================
# This file defines an automated workflow that runs when you push code
# 
# CI/CD = Continuous Integration / Continuous Deployment
# 
# What happens:
# 1. You push code to GitHub
# 2. GitHub automatically runs tests
# 3. If tests pass, builds Docker image
# 4. Runs security scans
# 5. (Optional) Deploys to production
#
# Benefits:
# - Catch bugs early
# - Ensure code quality
# - Automate repetitive tasks
# - Deploy faster and safer
# ============================================================================

name: CI/CD Pipeline  # Name of the workflow (shows in GitHub Actions tab)

# ----------------------------------------------------------------------------
# TRIGGERS - When to Run This Workflow
# ----------------------------------------------------------------------------
# This workflow runs automatically when:
# - Code is pushed to "main" or "develop" branches
# - A pull request is opened to "main" branch

on:
  push:
    branches: [ main, develop ]  # Run on push to these branches
  pull_request:
    branches: [ main ]            # Run on PRs to main branch

# ----------------------------------------------------------------------------
# JOBS - What to Do
# ----------------------------------------------------------------------------
# Jobs run in parallel (unless dependencies are specified)
# Each job runs on a fresh virtual machine

jobs:
  # --------------------------------------------------------------------------
  # JOB 1: TEST
  # --------------------------------------------------------------------------
  # This job tests the code to make sure it works
  
  test:
    name: Run Tests and Linting
    runs-on: ubuntu-latest  # Run on Ubuntu Linux (GitHub provides this)
    
    steps:
    # Step 1: Get the code
    - name: Checkout code
      uses: actions/checkout@v4  # This action downloads your code

    # Step 2: Set up Python
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'  # Use Python 3.11

    # Step 3: Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest  # Install testing tools

    # Step 4: Run linter (code quality checks)
    - name: Lint with flake8
      run: |
        # Check for syntax errors
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Check code style (warnings only)
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    # Step 5: Test the application
    - name: Test application
      run: |
        python -c "import app; print('✓ App imports successfully')"

  # --------------------------------------------------------------------------
  # JOB 2: BUILD
  # --------------------------------------------------------------------------
  # This job builds the Docker image
  # It only runs if the "test" job passes (needs: test)
  
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test  # Wait for "test" job to complete successfully
    
    steps:
    # Step 1: Get the code
    - name: Checkout code
      uses: actions/checkout@v4

    # Step 2: Set up Docker Buildx
    # Buildx is an advanced Docker build tool
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # Step 3: Build the Docker image
    - name: Build Docker image
      run: |
        docker build -t devops-learning-app:latest .

    # Step 4: Test the Docker image
    # Make sure the image actually works
    - name: Test Docker image
      run: |
        # Start container in background
        docker run -d -p 5000:5000 --name test-container devops-learning-app:latest
        
        # Wait for app to start (give it more time)
        echo "Waiting for container to start..."
        sleep 10
        
        # Check if container is running
        if ! docker ps | grep -q test-container; then
          echo "❌ Container is not running!"
          docker logs test-container
          exit 1
        fi
        
        # Test health endpoint (retry a few times)
        echo "Testing health endpoint..."
        for i in {1..5}; do
          if curl -f http://localhost:5000/health; then
            echo "✅ Health check passed!"
            break
          else
            echo "Attempt $i failed, retrying..."
            sleep 2
          fi
        done
        
        # Final check
        if ! curl -f http://localhost:5000/health; then
          echo "❌ Health check failed after retries"
          docker logs test-container
          exit 1
        fi
        
        # Clean up
        docker stop test-container
        docker rm test-container
        echo "✅ Docker image test passed!"

  # --------------------------------------------------------------------------
  # JOB 3: SECURITY SCAN
  # --------------------------------------------------------------------------
  # This job scans for security vulnerabilities
  # It only runs if "build" job passes
  
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build  # Wait for "build" job to complete
    # Permissions for uploading security scan results
    permissions:
      contents: read
      security-events: write  # Required to upload SARIF files
    
    steps:
    # Step 1: Get the code
    - name: Checkout code
      uses: actions/checkout@v4

    # Step 2: Run Trivy security scanner
    # Trivy scans for known vulnerabilities in dependencies
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'           # File system scan
        scan-ref: '.'             # Scan current directory
        format: 'sarif'           # Output format
        output: 'trivy-results.sarif'  # Output file

    # Step 3: Upload results to GitHub Security
    # This shows security issues in the GitHub Security tab
    # Note: This requires write permissions for security events
    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()  # Run even if previous step failed
      continue-on-error: true  # Don't fail pipeline if upload fails (permissions issue)
      with:
        sarif_file: 'trivy-results.sarif'

# ============================================================================
# WORKFLOW SUMMARY
# ============================================================================
# 
# When you push code:
# 1. ✅ Test job runs (checks code quality)
# 2. ✅ Build job runs (creates Docker image)
# 3. ✅ Security job runs (scans for vulnerabilities)
#
# If any job fails:
# - You get notified
# - You can see what went wrong in the Actions tab
# - Fix the issue and push again
#
# This ensures:
# - Code quality is maintained
# - Docker images are built correctly
# - Security issues are caught early
#
# ============================================================================
